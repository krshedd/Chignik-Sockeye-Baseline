---
title: "Chignik Sockeye Baseline Comparison - old functions vs. new functions"
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

# Purpose

I was testing the new function `create_bayes_baseline.GCL` and noticed some discrepancies between the *BAYES* file generated by that vs. what I had on file from the 2018 S190 baseline update. I want to re-create the baseline analysis with both the old GCL functions on `v.1.12.0-static` and the new GCL functions on `develop`.

# Old Functions - v1.12.0-static

```{r setup}
rm(list = ls())

library(tidyverse)
library(lubridate)

source("~/../R/Functions.GCL.R")
.username = "krshedd"
.password = ""

load_objects(path = "../../Mixtures/2019/Objects/", pattern = "ChignikCollections")
load_objects(path = "../../Mixtures/2019/Objects/", pattern = "Chignik16pops")
load_objects(path = "../../Mixtures/2019/Objects/", pattern = "_RAD")
```

## Create LocusControl

```{r 2019_locuscontrol}
CreateLocusControl.GCL(locusnames = loci24_RAD, username = .username, password = .password)
save_objects("LocusControl", path = "../2020/Objects_old_functions_v1.12.0-static/")
```

## Baseline collections

```{r read_baseline_genotypes}
LOKI2R.GCL(sillyvec = ChignikCollections,
           username = .username,
           password = .password)
```

## Data QA

Perform standard data QA processes to filter out untrustworthy genotypes.
```{r qa_setup_baseline}
sample_size_qa_baseline <- tibble(silly = ChignikCollections) %>% 
  mutate(genotyped = sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_baseline}
miss_loci_baseline <- RemoveIndMissLoci.GCL(sillyvec = ChignikCollections, proportion = 0.8)
save_objects("miss_loci_baseline", "../2020/Objects_old_functions_v1.12.0-static/")

# show individuals removed
miss_loci_baseline[miss_loci_baseline != "None"]

sample_size_qa_baseline <- sample_size_qa_baseline %>% 
  mutate(missing = genotyped - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_baseline}
duplicate_check_95_baseline <-
  CheckDupWithinSilly.GCL(
    sillyvec = ChignikCollections,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95
  )

duplicate_summary_baseline <-
  sapply(ChignikCollections, function(x)
    duplicate_check_95_baseline[[x]]$report, simplify = FALSE)

duplicate_remove_baseline <-
  RemoveDups.GCL(duplicate_check_95_baseline)

save_objects(
  c("duplicate_summary_baseline", "duplicate_remove_baseline"),
  "../2020/Objects_old_functions_v1.12.0-static/"
)

# show individuals removed
duplicate_remove_baseline[duplicate_remove_baseline != "Nothing Removed"]

sample_size_qa_baseline <- sample_size_qa_baseline %>% 
  mutate(duplicate = genotyped - missing - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_baseline}
(sample_size_qa_baseline <- sample_size_qa_baseline %>% 
  mutate(final = sapply(silly, function(x) get(paste0(x, ".gcl"))$n)))

write_csv(sample_size_qa_baseline, "../2020/sample_size_qa_baseline_v1.12.0-static.csv")
```

## Combine loci

Since I am just using the final 22 loci I need to combine GPDH and MHC2 into their final forms. 
```{r combine_loci_baseline}
CombineLoci.GCL(sillyvec = ChignikCollections, markerset = c("One_GPDH2", "One_GPDH"), update = TRUE)
CombineLoci.GCL(sillyvec = ChignikCollections, markerset = c("One_MHC2_251", "One_MHC2_190"), update = TRUE)
```

## Pool populations

```{r pool_baseline_populations}
chignik_baseline_pooling <- str_split(string = grep(pattern = "\\.", x = Chignik16pops, value = TRUE), pattern = "\\.")


lapply(chignik_baseline_pooling,
       function(x) {
         PoolCollections.GCL(
           collections = x,
           loci = loci22_RAD,
           IDs = NULL,
           newname = paste(x,
                           collapse = ".")
         )
       } )
```

## Save baseline populations

```{r save_baseline}
save_sillys(sillyvec = Chignik16pops, path = "../2020/Baseline genotypes v1.12.0-static/")
```

## Create *BAYES* baseline

```{r}
baseline_fortran <-
  CreateBaseline.GCL(
    sillyvec = Chignik16pops,
    loci = loci22_RAD,
    dir = "../2020/BAYES_baseline",
    basename = "Chignik16pops22RAD_v1.12.0-static",
    type = "BAYES"
  )

save_objects(objects = "baseline_fortran", path = "../2020/Objects_old_functions_v1.12.0-static/")
```

Read in *BAYES* baseline
```{r}
(x <- read_delim(file = "../2020/BAYES_baseline/Chignik16pops22RAD_v1.12.0-static.bse", delim = "\n", col_names = FALSE))
```

Read in quick and dirty *BAYES* baseline
```{r}
(x2 <- read_delim(file = "~/../Desktop/Local_Chignik_Inseason/2020/BAYES/Baseline/new_function_test.bse", delim = "\n", col_names = FALSE))
```

Are they the same?
```{r}
all.equal(x, x2)
```

# New Functions - develop

Pulled new functions with new .gcl style from `develop` branch
```{r setup_new}
rm(list = ls())

library(tidyverse)
library(lubridate)

source("~/../R/Functions.GCL.R")
.username = "krshedd"
.password = ""

load_objects(path = "../../Mixtures/2019/Objects/", pattern = "ChignikCollections")
load_objects(path = "../../Mixtures/2019/Objects/", pattern = "Chignik16pops")
load_objects(path = "../../Mixtures/2019/Objects/", pattern = "_RAD")
```

## Create LocusControl

```{r 2019_locuscontrol_new}
CreateLocusControl.GCL(locusnames = loci24_RAD, username = .username, password = .password)
save_objects("LocusControl", path = "../2020/Objects_new_functions_develop/")
```

## Baseline collections

```{r read_baseline_genotypes_new}
LOKI2R.GCL(sillyvec = ChignikCollections,
           username = .username,
           password = .password)
```

## Data QA

Perform standard data QA processes to filter out untrustworthy genotypes.
```{r qa_setup_baseline_new}
(
  sample_size_qa_baseline <-
    silly_n.GCL(sillyvec = ChignikCollections) %>%
    dplyr::rename(genotyped = n)
)
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_baseline_new}
miss_loci_baseline <- RemoveIndMissLoci.GCL(sillyvec = ChignikCollections, proportion = 0.8)
```

```{r}
save_objects("miss_loci_baseline", "../2020/Objects_new_functions_develop/")

# miss_loci_baseline %>% unnest(IDs_Removed)

(
  sample_size_qa_baseline <- sample_size_qa_baseline %>%
    left_join(silly_n.GCL(sillyvec = ChignikCollections), by = "silly") %>%
    mutate(missing = genotyped - n) %>%
    select(-n)
)
```


### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_baseline_new}
duplicate_check_95_baseline <-
  CheckDupWithinSilly.GCL(
    sillyvec = ChignikCollections,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95, 
    ncores = 4
  )
```

```{r}
duplicate_check_95_baseline
```

``` {r}
duplicate_remove_baseline <-
  RemoveDups.GCL(duplicate_check_95_baseline)

save_objects(
  c("duplicate_check_95_baseline", "duplicate_remove_baseline"),
  "../2020/Objects_new_functions_develop/"
)
```

```{r}
(
  sample_size_qa_baseline <- sample_size_qa_baseline %>%
    left_join(silly_n.GCL(sillyvec = ChignikCollections), by = "silly") %>%
    mutate(duplicate = genotyped - missing - n) %>%
    select(-n)
)
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_baseline_new}
(
  sample_size_qa_baseline <- sample_size_qa_baseline %>%
    left_join(silly_n.GCL(sillyvec = ChignikCollections), by = "silly") %>%
    dplyr::rename(final = n)
)

write_csv(sample_size_qa_baseline, "../2020/sample_size_qa_baseline_develop.csv")
```

```{r}
missing_indvs_loci
```

There are some minor sample size discrepancies between the two methods.
The "new" functions failed to read in SALEC97_96 and SHATE08E_16, and also found an additional duplicate in SBROAD97.

## Combine loci

Since I am just using the final 22 loci I need to combine GPDH and MHC2 into their final forms. 
```{r combine_loci_baseline_new}
CombineLoci.GCL(sillyvec = ChignikCollections, markerset = c("One_GPDH2", "One_GPDH"), update = TRUE)
CombineLoci.GCL(sillyvec = ChignikCollections, markerset = c("One_MHC2_251", "One_MHC2_190"), update = TRUE)
```

## Pool populations

```{r pool_baseline_populations_new}
chignik_baseline_pooling <- str_split(string = grep(pattern = "\\.", x = Chignik16pops, value = TRUE), pattern = "\\.")


lapply(chignik_baseline_pooling,
       function(x) {
         PoolCollections.GCL(
           collections = x,
           loci = loci22_RAD,
           IDs = NULL,
           newname = paste(x,
                           collapse = ".")
         )
       } )
```

## Save baseline populations

```{r save_baseline_new}
save_sillys(sillyvec = Chignik16pops, path = "../2020/Baseline genotypes develop/")
```

## Create *BAYES* baseline

```{r}
baseline_fortran <-
  create_bayes_baseline.GCL(
    sillyvec = Chignik16pops,
    loci = loci22_RAD,
    dir = "../2020/BAYES_baseline",
    baseline_name = "Chignik16pops22RAD_develop",
    ncores = 4
  )

save_objects(objects = "baseline_fortran", path = "../2020/Objects_new_functions_develop/")
```


# Compare *BAYES* files

## Testing `create_bayes_baseline.GCL`

Read in *BAYES* baseline based on old functions from v1.12.0-static
```{r}
(
  baseline_2020_static <-
    read_delim(
      file = "../2020/BAYES_baseline/Chignik16pops22RAD_v1.12.0-static.bse",
      delim = "\n",
      col_names = FALSE
    )
)
```

Read in quick and dirty *BAYES* baseline from the "Baseline genotypes" that I'd saved, converted old .gcl to new
```{r}
(
  baseline_2018_oldgcl_newbayesfunction <-
    read_delim(
      file = "~/../Desktop/Local_Chignik_Inseason/2020/BAYES/Baseline/new_function_test.bse",
      delim = "\n",
      col_names = FALSE
    )
)
```

Are they the same?
```{r}
all.equal(baseline_2020_static, baseline_2018_oldgcl_newbayesfunction)
```

Cool, so the only difference between those two baselines is the new `create_bayes_baseline.GCL` vs. `CreateBaseline.GCL`

## Testing new vs. old

```{r}
(
  baseline_2020_develop <-
    read_delim(
      file = "../2020/BAYES_baseline/Chignik16pops22RAD_develop.bse",
      delim = "\n",
      col_names = FALSE
    )
)
```

```{r}
all.equal(baseline_2020_develop, baseline_2020_static)
```

Nope, these are not the same. We already knew this, because the sample sizes are different.

## Testing old vs. 2018

```{r}
(
  baseline_2018_chase <-
    read_delim(
      file = "../2018/BAYES/Baseline/Chignik16pops22RAD.bse",
      delim = "\n",
      col_names = FALSE
    )
)
```

```{r}
all.equal(baseline_2018_chase, baseline_2020_static)
```

Shit, there are 136 differences

```{r}
all.equal(baseline_2018_chase, baseline_2020_develop)
```

Fuuuuck, there are 179 differences. Since we are planning to use the `develop` baseline moving forward, I should investigate how big these differences are and potentially re-run some 2019-2020 mixtures to see if the differences matter in terms of stock comp...

God damnit, the new functions failed for the combined markers! It looks like `CombineLoci.GCL` put the alleles in the wrong order, so `FreqPop.GCL` was not able to calculate the allele counts properly, because all of the counts look like *illegal* alleles (i.e. not in `LocusControl`). Need to do some digging in `CombineLoci.GCL` to see what the hell is going on, because `LocusControl` and the actual alleles in the .gcl objects do *NOT* agree (9/18/2020 KS).
